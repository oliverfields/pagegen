#!/usr/bin/python

from Utility import report_error, report_notice, load_config, get_site_conf_path, PAGEGENCONF, SITECONF, HOME, CONFROOT, TARGETDIR
from os.path import expanduser, basename, join
from os import getcwd, listdir, sep
from sys import exit, argv
from distutils.dir_util import copy_tree
from Site import Site


# Variables
verbose=False


def usage(exit_after=True):
	print 'Usage: %s <gen|init>' % (basename(argv[0]))

	if exit_after:
		exit(0)


def exec_hook(path):
	''' Run specified hook if executable '''
	return True


def gen_mode(config):
	site_conf_path=get_site_conf_path()

	if not site_conf_path:
		report_error(1, "Not in pagegen directory tree, unable to find site.conf in current folder or parent folders")

	site_dir=site_conf_path[:-len(sep+SITECONF)]

	try:
		s=Site(site_dir, site_conf_path)
	except Exception as e:
		report_error(1, "Unable to load site: %s" % e)

	try:
		s.generate_pages(s.pages)
	except Exception as e:
		report_error(1, "Unable to generate site: %s" % e)

	try:
		s.move_to_target()
	except Exception as e:
		report_error(1, "Unable to copy to target directory '%s': %s" % (s.target_dir, e))


def init_mode(config):
	''' Copy skeleton directory to current directory for basic setup '''

	skel_dir=config.get(CONFROOT, 'skel_dir')
	root_dir=getcwd()

	if listdir(root_dir):
		report_error(1,"Cannot init non empty directory '%s'" % root_dir)

	try:
		copy_tree(skel_dir, root_dir)
	except Exception as e:
		report_error(1, "Unable to copy '%s' to '%s': %s" % (skel_dir, root_dir, e))


# Parse CLI arguments
if __name__ == '__main__':
	try:
		mode=argv[1]
	except Exception as e:
		usage()

	possible_configs=[
		getcwd()+sep+PAGEGENCONF,
		HOME+sep+'.config'+sep+PAGEGENCONF,
		sep+'etc'+sep+PAGEGENCONF
	]

	config=load_config(possible_configs)

	if mode == "gen":
		gen_mode(config)
	elif mode == "init":
		init_mode(config)
	else:
		usage(False)
		report_error(1, 'Unknown mode "%s"' % mode)